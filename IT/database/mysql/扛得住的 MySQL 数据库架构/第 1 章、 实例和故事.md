# 第 1 章 实例和故事

####引言

是什么决定了双 11 大促的成败？

面对高访问量，web 服务器可以横向扩展，但是数据库因为完整性和一致性，如果我们在多出写入相同的数据，这种完整性和一致性就会被破坏，数据库的扩展还真是让我们头疼。

如果没有稳定的数据库及服务器环境一切的一切全是一场空。



PV = page view
TPS = transactions per second
QPS = queries per second
RPS = requests per second

RPS = 并发数/平均响应时间



QPS：每秒钟处理的查询量

- 例如 10ms 处理 1 个 sql
- 1s 处理 100 个sql
- QPS <= 100



- 再比如 100 ms 处理 1 个 sql
- QPS <= 10



对于数据库来说，一个 sql 执行 10 ms 和 100 ms 是有天壤之别的

以过往的经验来看，数据库的问题，80% 是由于慢查询造成的

QPS = 并发量 / 平均响应时间 = 总请求数 / ( 进程总数 * 请求时间 )





#### 1. 在双 11 大促中的数据库服务器

数据库架构



最好不要在主库上数据库备份，大型活动前取消这类计划



#### 2. 在大促中什么影响了数据库性能

影响数据库的因素

- sql 查询速度
- 网卡流量
- 服务器硬件
- 磁盘 IO



- 超高的 QPS 和 TPS

  - 风险：效率低下的 SQL

- 大量的并发：

  - 风险：数据库连接数被占满（max_connections 默认 100）

- 超高的 CPU 使用率

  - 风险：因 CPU 资源耗尽而出现宕机

- 磁盘 IO

  - 风险：磁盘 IO 性能突然下降（使用更快的磁盘设备）
  - 其它大量消耗磁盘性能的计划任务（调整计划任务，做好磁盘维护）

- 网卡流量

  - 风险：网卡 IO 被占满（1000 Mb ≈ 100 MB）
  - 如何避免无法连接数据库的情况：
    - 减少从服务器的数量
    - 进行分级缓存
    - 避免使用”select*“进行查询

- 大表带来的问题

  1. 什么样的表可以称为大表？

     - 记录行数巨大，单表超过千万行
     - 表数据文件巨大，表数据文件超过 10 G

     这个定义是相对的，比如超过千万行的单表，只有 insert 和 select 操作， 而几乎没有 update 和 delete 操作的话，这样的表就算操作了千万行也不会对我们业务有什么影响

     但是也有例外的情况，比如有个 10 个亿的表， 给这张表增加列，会非常痛苦。 

  2. 大表对查询的影响

     - 慢查询：很难在一定的时间内过滤出所需要的数据

     - 大表对 DDL 操作的影响：建立索引需要很长的时间

       - MySQL版本 < 5.5 建立索引会锁表
       - MySQL 版本 >= 5.5 虽然不会锁表但会引起主从延迟

     - 修改表结构需要长时间锁表

       - 会造成长时间的主从延迟
       - 影响正常的数据操作

     - 如何处理数据库中的大表

       - 分库分表把一张大表分成多个小表
       - 难点
         - 分表主键的选择
         - 分表后跨分区数据的查询和统计

     - 大表的历史数据归档，减少对前后端业务的影响

       - 难点

         - 归档时间点的选择
         - 如何进行归档操作

- 大事务带来的问题

  1. 事务是数据库系统区别于其它一切文件系统的重要特性之一
  2. 事物是一组具有原子性的 SQL 语句，或是一个独立的工作单元

  事务

  - 原子性
    - 定义：一个事物必须被视为一个不可分割的最小工作单元，整个事务中的所有操作要么全部提交成功，要么全部失败，对于一个事物来说，不可能只执行其中的一部分操作
  - 一致性
    - 定义：一致性是指事务将数据库从一种一致性状态转换到另外一种一致性状态，在事务开始之前和事务结束后数据库中数据的完整性没有被破坏
  - 隔离性
    - 定义：隔离性要求一个事务对数据库中数据的修改，在未提交完成前对于其它事务是不可见的
    - SQL 标准中定义的四种隔离级别（隔离性由低到高，并发性由高到低）
      - 未提交读（READ UNCOMMITED）
      - 已提交读（READ COMMITED）
      - 可重复读（REPEATABLE READ）
      - 可串行化（SERIALIZABLE）
  - 持久性 
    - 定义：一旦事务提交，则其所作的修改就会永久保存到数据库中。此时即使系统崩溃，已经提交的修改数据也不会丢失。

- 大事务

  - 定义：运行时间比较长，操作的数据比较多的事务
  - 风险：
    - 锁定太多的数据，造成大量的阻塞和锁超时
    - 回滚时所需时间比较长
    - 执行时间长，容易造成主从延迟
  - 如何处理大事务?
    - 避免一次处理太多的数据
    - 移出不必要在事务中的 SELECT 操作
  - 总结
    - 直观的展示了数据库在繁忙时的系统状态
    - 简单了解了对性能有影响的一些因素



















