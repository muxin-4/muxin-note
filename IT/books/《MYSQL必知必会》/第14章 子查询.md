# 第14章 子查询

**查询（query ）**

任何SQL语句都是查询。但此术语一般指SELECT语句。

**子查询最常见的使用是在WHERE 子句的IN 操作符中，以及用来填充计算列。**

## 14.2 子查询

订单存储在两个表中。对于包含订单号、客户ID 、订单日期的每个订单，orders 表存储一行。各订单的物品存储在相关的orderitems 表中。orders 表不存储客户信息。它只存储客户的ID 。实际的客户信息存储在customers 表中。

**现在，假如需要列出订购物品TNT2 的所有客户，应该怎样检索？下面列出具体的步骤。**

-  检索包含物品TNT2 的所有订单的编号。
-  检索具有前一步骤列出的订单编号的所有客户的ID 。
-  检索前一步骤返回的所有客户ID 的客户信息。

```
SELECT cust_id
FROM orders
WHERE order_num IN (SELECT order_num
					FROM orderitems
					WHERE prod_id = 'TNT2')
```

**输出**
+---------------+
|   cust_id   |
+---------------+
|      10001 | 
|      10004 | 

**在SELECT语句中，子查询总是从内向外处理。** 	

首先，它执行下面的查询：

`SELECT order_num FROM orderitems WHERE prod_id = 'TNT2'`

此查询返回两个订单号：20005 和20007 。然后，这两个值以IN 操作符要求的逗号分隔的格式传递给外部查询的WHERE 子句。外部查询变成：

`SELECT cust_id FROM orders WHERE order_num IN (20005, 20007)`



## 14.3 作为计算字段使用子查询

使用子查询的另一方法是创建计算字段。假如需要显示customers表中每个客户的订单总数。订单与相应的客户ID 存储在orders 表中。

为了执行这个操作，遵循下面的步骤。

(1)  从customers 表中检索客户列表。

(2)  对于检索出的每个客户，统计其在orders 表中的订单数目。

```
SELECT COUNT(*) AS orders
FROM orders
WHERE cust_id = 10001;
```

为了对每个客户执行COUNT(*) 计算，应该将COUNT(*) 作为一个子查询。请看下面的代码：这

```
SELECT cust_name,
	   cust_state,
	   (SELECT COUNT(*)
	   	FROM orders
	   	WHERE orders.cust_id = customers.cust_id) AS orders
FROM customers
ORDER BY cust_name;
```

子查询中的WHERE 子句与前面使用的WHERE 子句稍有不同，因为它使用了完全限定列名（在第4 章中首次提到）。下面的语句告诉SQL 比较orders 表中的cust_id 与当前正从customers 表中检索的cust_id ：

`WHERE orders.cust_id = customers.cust_id`













