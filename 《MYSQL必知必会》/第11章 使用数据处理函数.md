# 第11章 使用数据处理函数

## 11.1 函数

与其他大多数计算机语言一样，SQL 支持利用函数来处理数据。函数一般是在数据上执行的，它给数据的转换和处理提供了方便。

**注**

* 能运行在多个系统上的代码称为可移植的（portable ）。相对来说，多数SQL 语句是可移植的，在SQL 实现之间有差异时，这些差异通常不那么难处理。而函数的可移植性却不强。几乎每种主要的DBMS 的实现都支持其他实现不支持的函数，而且有时差异还很大。
*  为了代码的可移植，许多SQL 程序员不赞成使用特殊实现的功能。虽然这样做很有好处，但不总是利于应用程序的性能。如果不使用这些函数，编写某些应用程序代码会很艰难。必须利用其他方法来实现DBMS 非常有效地完成的工作。
*  如果你决定使用函数，应该保证做好代码注释，以便以后你（或其他人）能确切地知道所编写SQL 代码的含义。

## 11.2 使用函数

 大多数SQL 实现支持以下类型的函数。

*  用于处理文本串（如删除或填充值，转换值为大写或小写）的**文本函数**。
*  用于在数值数据上进行算术操作（如返回绝对值，进行代数运算）的**数值函数**。
*  用于处理日期和时间值并从这些值中提取特定成分（例如，返回两个日期之差，检查日期有效性等）的**日期和时间函数**。
*  返回DBMS 正使用的特殊信息（如返回用户登录信息，检查版本细节）的**系统函数**。



### 11.2.1 文本处理函数

常用文本处理函数

|  函  数   |        说  明        |
| :-------: | :------------------: |
|  Left()   |   返回串左边的字符   |
|  Right()  |   返回串右边的字符   |
| Length()  |     返回串的长度     |
| Locate()  |   找出串的一个子串   |
|  Lower()  |    将串转换为小写    |
|  LTrim()  |   去掉串左边的空格   |
|  RTrim()  |   去掉串右边的字符   |
|  Trim()   | 去掉串左右两边的空格 |
| Soundex() |  返回串的SOUNDEX值   |
| SubString() |  返回子串的字符   |
| Upper() |  将串转换为大写  |

**注**

SOUNDEX是一个将任何文本串转换为描述其语音表示的字母数字模式的算法。SOUNDEX考虑了类似的发音字符和音节，使得能对串进行发音比较而不是字母比较。虽然SOUNDEX不是SQL概念，但MySQL（就像多数DBMS一样）都提供对SOUNDEX的支持。

下面给出一个使用Soundex() 函数的例子。customers 表中有一个顾客Coyote Inc. ，其联系名为Y.Lee 。但如果这是输入错误，此联系名实际应该是Y.Lie ，怎么办？显然，按正确的联系名搜索不会返回数据，如下所示：

```
SELECT cust_name, cust_contact
FROM customers
WHERE cust_contact = 'Y.Lie';
```

现在试一下使用Soundex() 函数进行搜索，它匹配所有发音类似于Y.Lie 的联系名：

```
SELECT cust_name, cust_contact
FROM customers
WHERE Soundex(cust_contact) = Soundex('Y.Lie');
```

**分析**

在这个例子中，WHERE 子句使用Soundex() 函数来转换cust_contact 列值和搜索串为它们的SOUNDEX 值。因为Y.Lee 和Y.Lie 发音相似，所以它们的SOUNDEX 值匹配，因此WHERE 子句正确地过滤出了所需的数据。

### 11.2.2 日期和时间处理函数

|  函  数   |          说  明          |
| :-------: | :----------------------: |
| AddDate() | 增加一个日期（天、周等） |
| AddTime() | 增加一个时间（时、分等） |
| CurDate() | 返回当前日期 |
| CurTime() | 返回当前时间 |
| Date() | 返回日期时间的日期部分 |
| DateDiff() | 计算两个日期之差 |
| Date_Add() | 高度灵活的日期运算函数 |
| Date_Format() | 返回一个格式化的日期或时间串 |
| Day() | 返回一个日期的天数部分 |
| DayOfWeek() | 对于一个日期，返回对应的星期几 |
| Hour() | 返回一个时间的小时部分 |
| Minute() | 返回一个时间的分钟部分 |
| Month() | 返回一个日期的月份部分 |
| Now() | 返回当前日期和时间 |
| Second() | 返回一个时间的秒部分 |
| Time() | 返回一个日期时间的时间部分 |
| Year() | 返回一个日期的年份部分 |

**注**

* 无论你什么时候指定一 个日期，不管是插入或更新表值还是用WHERE 子句进行过滤，日期必须为格式yyyy-mm-dd。
* 如果要的是日期，使用Date() 函数更可靠
* 如果要的是时间，使用Time()函数

如果你想检索出2005 年9 月下的所有订单，怎么办？

```
SELECT cust_id, order_num
FROM orders
WHERE Year(order_date) = 2005 AND Mont(order_date) = 9;
```

**分析**

Year()是一个从日期（或日期时间）中返回年份的函数。类似，Month()从日期中返回月份。因此，WHERE Year(order_date)= 2005 AND Month(order_date) = 9检索出order_date为2005年9月的所有行。

**注**

**MySQL的版本差异**

MySQL 4.1.1中增加了许多日期和时间函数。如果你使用的是更早的 MySQL版本，应该查阅具体的文档以确定可以使用哪些函数。

### 11.2.3 数值处理函数

数值处理函数仅处理数值数据。这些函数一般主要用于代数、三角或几何运算，因此没有串或日期—时间处理函数的使用那么频繁。

具有讽刺意味的是，在主要DBMS 的函数中，数值函数是最一致最统一的函数。表11-3 列出一些常用的数值处理函数。
| 函  数 |       说  明       |
| :----: | :----------------: |
| Abs()  | 返回一个数的绝对值 |
| Cos() | 返回一个角度的余弦 |
| Exp() | 返回一个数的指数值 |
| Mod() | 返回除操作的余数 |
| Pi() | 返回圆周率 |
| Rand() | 返回一个随机数 |
| Sin() | 返回一个角度的正弦 |
| Sqrt() | 返回一个数的平方根 |
| Tan() | 返回一个角度的正切 |







